<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<link rel="stylesheet" type="text/css" href="../../css/table_jui.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/comm.css"/>
		<link href="../../css/redmond/jquery.ui.all.css" rel="stylesheet"
			type="text/css"/>
		<link rel="stylesheet" href="../../css/ui.tabs.css" type="text/css"
			media="print, projection, screen"/>
		<link rel="stylesheet" type="text/css" href="../../css/drag-drop-folder-tree.css" />
		<link rel="stylesheet" type="text/css" href="../../css/context-menu.css"></link>
		<!--[if lte IE 7]>
<link rel="stylesheet" href="../../css/ui.tabs-ie.css" type="text/css" media="projection, screen">
<![endif]-->
		<script src="../../js/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" language="javascript"
			src="../../js/jquery-ui-1.8.16.custom.min.js"></script>
		<script src="../../js/ui.tabs.js" type="text/javascript"></script>
		<script type="text/javascript" language="javascript"
			src="../../js/jquery.dataTables.min.js"></script>
		<script type="text/javascript" language="javascript"
			src="../../js/checkForm.js"></script>
		<script type="text/javascript" language="JavaScript1.2"
			src="../../js/Calendar3.js"></script>
	<script type="text/javascript" language="javascript" src="../../js/myDtree.js" ></script>
	<script type="text/javascript" language="javascript" src="../../js/context-menu.js"></script>
	<script type="text/javascript" language="javascript" src="../../js/drag-drop-folder-tree.js" ></script>
	
<script type="text/javascript">
	var oTable=null;
	var isSaveOK=false;
	var info_id=0;
	var modelhouse="";
	var modelhouseid=0;
	var cust_code="";
	var require_id='';
	var productId=0;
	var product="";
	var objs="";
	var orderDetailId=0;
	var orderdetailList=[];
	var selectedProduct=[];
	var Customizetrid=1;
	var Customizetrnum=0;
	var controltrid=1;
	var controltrnum=0;
	var changetrid=1;
	var changetrnum=0;
	var customize="";
	var old_product="";
	var customizeid="";
	var cyclecontrol="";
	var controlid="";
	var changeinfo="";
	var ch_product={};
	var detailid=0;
	var minTime=10000000000;
	var maxTime=0;
	var constructId=0;
	var ids="";//采购单信息获取的订单详情号
	var designerCode="";
	var productList=[];
	var typeList=[];
	var orderInfo={};
	var orderdetail=[];
	var tempAmout=0;
	var productIndex=0;
	var curProductIndex=0;
	var total_money=0;
	var remind_id='';
	var pro_designer='';
	var examine_status="";//产品报价审核状态
	var examine_opinion="";
   $(document).ready(function() {
	  loadProTree();//初始化产品类型树
	  initData(); 
	  getAllProductList();//加载所有产品类别
	  getProductList();//加载所有产品
	
   });
   	
	//初始化
	function initData(){
		$("#tdprogramme_manager").html(top.getUserListByRole('programme_manager','programme_manager',true));
		$("#tdbox_designer").html(top.getUserListByRole('box_designer','box_designer',true));
			 var today=new Date();
			 $("#order_date").html(top.getTimeStr(today.getTime(),true));
			require_id=top.getUrlParam(document.URL,"require_id");
			cust_code=top.getUrlParam(document.URL,"cust_code");
			if(require_id!=''&&require_id!=null){
				getProjectInfo();
			}else if(cust_code!=null && cust_code!=null){
				getProjectInfo();
			}
			//saveProOrderInfo();//显示编辑状态
			//$("#cancleProBtn").hide();//隐藏取消按钮
    }
	
	//若是在客户详细信息页面单击新增时，会将客户编号带过来，然后查询客户的相关信息，更新页面显示
	function getCustInfo(){
	    var aoData=[];
		aoData.push( { "name": "custInfo.code", "value": cust_code } );
	    top.sendAjaxRequest("/actions/CustInfo.action?getFitmentCustInfo",aoData,getCustInfoCallBack);
	}
	
	function getCustInfoCallBack(obj){
	   if(obj.status=true){
	      var o=obj.body;
	      $("#view_cust_name").text(o.cust_name);
		  $("#view_cust_tel").text(o.cust_mobile);
		  $("#view_designerCode").text(top.getUserNameByCode(o.requireInfo.require_manager));
		  $("#view_tdpro_designer").text(top.getUserNameByCode(top.getProductDesignerByDesigner(o.requireInfo.require_manager)));//产品设计师
		   $("#view_pro_add").text(top.getCodeName("DISTRICT",o.requireInfo.district)+''+o.requireInfo.project_addr);
		  $("#cust_name").html(o.cust_name);
		  $("#cust_tel").html(o.cust_mobile);
		  $("#pro_add").html(top.getCodeName("DISTRICT",o.requireInfo.district)+''+o.requireInfo.project_addr);
		  $("#designerCode").html(top.getUserNameByCode(o.requireInfo.require_manager));
		  designerCode=o.requireInfo.require_manager;
	      pro_designer=top.getProductDesignerByDesigner(designerCode);	
		 $("#tdpro_designer").text(top.getUserNameByCode(pro_designer)); //产品设计师		
	   }else{
	      top.showInfoWinError("获取客户信息失败！");
	   }
	}

    function checkFormDoQuote(productId){
		var msg="";
		msg += checkString($("#type_"+productId+"_product_name").val(),true,64,"产品名称");
		msg += checkString($("#type_"+productId+"_amount").val(),true,8,"数量");
		if(!IsFloat( $("#type_"+productId+"_amount").val()))msg += "数量应为数字类型<br>";
		return msg;
	 }
   //调用回调函数---添加订单明细信
   function saveOrderDetailCallBack(obj){
	try{
        if ( obj.status == true ){
            isSaveOK = true;
            top.showInfoWinOK("操作成功");
			isSaveOK = true;
			parent.closeDialog();
        }else{
            isSaveOK = false;
            top.showInfoWinError("操作失败 "+obj.msg);
        }
       }catch(e){
          top.showInfoWinError("处理异常:"+e.message);
       }
	
   }
  
   //删除从选择页面返回来的，而且数据库里还没有的产品记录（明细列表）
   function deleteProduct(productId){
	 // 根据 TR id 删除<tr>标签对象
	 $("#add_product_"+productId).remove();
	 selectedProduct.length--;
   }
   
	//关闭第二层框
	function closeDialog(){
		$( "#dialog" ).dialog( "close" );
	}
  
	
	// 保存基本信息
    function doSubmit(){
	if($("#saveCustBtn").html()=='保存'){
     var aoData=[];
		  // 检查
	var checkMsg = checkFormDoSubmit();
	    if ( checkMsg != '' ) {
	      // top.showInfoWinWarn(checkMsg);
           //return ;
	    }
		//订单基本信息信息

		aoData.push( { "name": "order.order_id", "value": info_id } );
		aoData.push( { "name": "order.cust_code", "value": $("#cust_code").val() } );
		aoData.push( { "name": "order.order_type", "value": $("#order_type").val() } );
		aoData.push( { "name": "order.fitment_designer", "value": $("#fitment_designer").val() } );
		aoData.push( { "name": "order.engineer_manager", "value": $("#engineer_manager").val() } );
		aoData.push( { "name": "order.project_manager", "value": $("#project_manager").val() } );
		aoData.push( { "name": "order.product_designer", "value": $("#product_designer").val() } );
		aoData.push( { "name": "order.cust_manager", "value": $("#cust_manager").val() } );
		aoData.push( { "name": "order.pay_money_date", "value": top.toTimestamp($("#pay_money_date").val()) } );
		aoData.push( { "name": "order.status", "value": $("#status").val() } );
		aoData.push( { "name": "order.total_amount", "value": top.g_GetNumValue($("#total_amount").val()) } );
		aoData.push( { "name": "order.earnest_money", "value": top.g_GetNumValue($("#earnest_money").val()) } );
		
	var xurl="/actions/ProjectOrder.action?updateOrderInfo";
	 if ( info_id == 0 ) {
	    xurl="/actions/ProjectOrder.action?insertOrderInfo";
	 }
     top.sendAjaxRequest(xurl,aoData,optCallback);
	 }else{
	 $("#edit_cust_info").show();
	 $("#view_cust_info").hide();
	 $("#saveCustBtn").html('保存');
	 $("#cancleCustBtn").show();
	 }
   }

	
	// 关闭当前页面前，页面框架自动调用的函数
	function doBeforeClose(){
     var obj={
              "isSaveOK":isSaveOK
            };
     top.setTempValue(obj);
   }

	
	function saveProOrderInfo(){
	//产品订单字段
		var aoData=[];
		aoData.push( { "name": "orderInfo.require_id", "value": require_id } );
		aoData.push( { "name": "orderInfo.cust_name", "value": $("#cust_name").html() } );
		aoData.push( { "name": "orderInfo.designerCode", "value":designerCode } );
		aoData.push( { "name": "orderInfo.pro_designer", "value": pro_designer } );
		aoData.push( { "name": "orderInfo.box_designer", "value": $("#box_designer").val() } );

		aoData.push( { "name": "orderInfo.cust_tel", "value": $("#cust_tel").html() } );
		aoData.push( { "name": "orderInfo.pro_add", "value": $("#pro_add").html() } );
		aoData.push( { "name": "orderInfo.project_order_id", "value": $("#project_order_id").html() } );
		aoData.push( { "name": "orderInfo.cust_code", "value":cust_code} );
	//产品详情字段
		var type_ids="";
		var product_ids="";
		var product_brands="";
		var product_names="";
		var product_models="";
		var product_standards="";
		var units="";
		var use_positions="";
		var sale_prices="";
		var discounts="";
		var amounts="";
		var typeId="";
		var prices="";
		var sale_modes="";
		if(productIndex!=0){
			for(var i=0;i<productIndex+1;i++){
					if(!$("#type_"+i).val()){
						continue;
					}
					if($("#type_"+i).val()!=null&&$("#type_"+i+"_product_name").val()!=null&&$("#type_"+i+"_product_name").val()!=''){
						var checkMsg = checkFormDoQuote(i);
						if ( checkMsg != '' ) {
							top.showInfoWinWarn(checkMsg);
							return ;
						}
						type_ids+=$("#type_"+i).val()+",";
						product_ids+=$("#type_"+i+"_product_id").val()+",";
						product_brands+=$("#type_"+i+"_product_brand").val()+",";
						product_names+= $("#type_"+i+"_product_name").find("option:selected").text()+",";
						product_models+=$("#type_"+i+"_product_model").html()+",";
						product_standards+=$("#type_"+i+"_product_standard").html()+",";
						units+=$("#type_"+i+"_unit").val()+",";
						sale_prices+=$("#type_"+i+"_sale_price").html()+",";
						discounts+=$("#type_"+i+"_discount").html()+",";
						amounts+=$("#type_"+i+"_amount").val()+",";
						prices+=$("#type_"+i+"_price").html()+",";
						sale_modes+= $("#type_"+i+"_sale_mode").html()+",";
						if($("#type_"+i+"_use_position").val()!=''){
							use_positions+=$("#type_"+i+"_use_position").val()+",";
						}else{
							use_positions+="无,";
						}
					}
				}
				/*if(info_id==0){
					 top.showInfoWinWarn("请首先保存客户基本信息！");
					 return;
				}*/
				if(type_ids!=''){
					//aoData.push( { "name": "orderdetail.order_id", "value":info_id } );
					aoData.push( { "name": "type_idStr", "value": type_ids} );
					aoData.push( { "name": "product_idStr", "value": product_ids} );
					aoData.push( { "name": "orderdetail.product_brand", "value":product_brands} );
					aoData.push( { "name": "orderdetail.product_name", "value": product_names} );
					aoData.push( { "name": "orderdetail.product_model", "value": product_models } );
					aoData.push( { "name": "orderdetail.product_standard", "value": product_standards} );
					aoData.push( { "name": "orderdetail.unit", "value":units } );
					aoData.push( { "name": "orderdetail.use_position", "value": use_positions} );
					aoData.push( { "name": "orderdetail.sale_mode", "value": sale_modes} );
					aoData.push( { "name": "sale_priceStr", "value":sale_prices} );
					aoData.push( { "name": "discountStr", "value":discounts} );
					aoData.push( { "name": "amountStr", "value": amounts} );
					aoData.push( { "name": "prices", "value": prices} );	
			}
			var xurl="/actions/ProductOrder.action?insertOrderDetail";
			top.sendAjaxRequest(xurl,aoData,saveProOrderInfoCallback);
		}
	}
	//保存信息---回调函数
	function saveProOrderInfoCallback(obj){
		try{
			if ( obj.status == true ){
				isSaveOK = true;
				top.showInfoWinOK("操作成功");
				 parent.closeDialog();
			}else{
				isSaveOK = false;
				top.showInfoWinError("操作失败 "+obj.msg);
			}
		   }catch(e){
			  top.showInfoWinError("处理异常:"+e.message);
		   }
	}
	//选择工程订单
	function chooseProject(){
		var xurl="/pages/pro09/chooseProjectOrder.html?require_id="+require_id+"&cust_code="+cust_code;
		openDialog("选择工程订单",xurl,true,900,500,chooseProjectCallBack);
	}
	function getProjectInfo(){
	    
			var aoData=[];
		    aoData.push( { "name": "projectOrder.require_id", "value": require_id } );
		    aoData.push( { "name": "projectOrder.cust_code", "value": cust_code } );
			top.sendAjaxRequest("/actions/ProjectOrder.action?getProjectOrderinfo",aoData,getProjectInfoCallBack);
	}
	function getProjectInfoCallBack(obj){
				if(obj.status==true){
					o=obj.body;
					if(o){
						cust_code=o.cust_code ;
						require_id=o.require_id;
						$("#project_order_id").html(o.project_order_id);
					}
					var aoData=[];
					aoData.push( { "name": "custInfo.code", "value":cust_code } );
					top.sendAjaxRequest("/actions/CustInfo.action?getFitmentCustInfo",aoData,custDetailCallback);
				}else{
					isSaveOK = false;
					top.showInfoWinError("操作失败 "+obj.msg);
				}
	}
	function custDetailCallback(obj){
	   try{
			if ( obj.status == true ){
			  var o=obj.body;
			  if(o)
				{
					$("#cust_name").html(o.cust_name);
					$("#cust_tel").html(o.cust_mobile);
					if ( o.requireInfo ) {
						$("#pro_add").html(top.getCodeName("DISTRICT",o.requireInfo.district)+o.requireInfo.project_addr);
						designerCode=o.requireInfo.require_manager;
						pro_designer=top.getProductDesignerByDesigner(designerCode);
						$("#designerCode").html(top.getUserNameByCode(o.requireInfo.require_manager)); 	
					    $("#tdpro_designer").text(top.getUserNameByCode(pro_designer)); //产品设计师			
					}else{
						$("#pro_add").html("");
						$("#designerCode").html("");
						$("#tdpro_designer").html("");
					}
				}else{
					$("#cust_name").html("");
					$("#cust_tel").html("");
					$("#pro_add").html("");
					$("#designerCode").html("");
					$("#tdpro_designer").html("");
				
				}
			 
		    }
		}catch(e){}
	}
	function getFitmentInfo(){
		var aoData=[];
		aoData.push( { "name": "custInfo.code", "value": cust_code } );
		top.sendAjaxRequest("/actions/CustInfo.action?getFitmentCustInfo",aoData,custDetailCallback);
	}
	//调用回调函数---调用查询选择方法
   	function chooseProjectCallBack(){
		try{
			var o = top.getTempValue();
			if(o){
			    if(o.project_order_id){
					$("#project_order_id").html(o.project_order_id);
					cust_code=o.cust_code ;
					require_id=o.require_id;
					var aoData=[];
					aoData.push( { "name": "custInfo.code", "value": cust_code } );
					top.sendAjaxRequest("/actions/CustInfo.action?getFitmentCustInfo",aoData,custDetailCallback);
				}
			}
		}catch(e){}
   }
   //选择客户
	function chooseCust(){
		var xurl="/pages/pro09/chooseCust.html";
		openDialog("选择客户",xurl,true,700,500,chooseCustCallBack);
	}
	function getAllProductList(){
	   top.sendAjaxRequest("/actions/ProductInfo.action?getProductTypeList",null,proTypeCallback);		
	}
	
	function proTypeCallback(obj){
	 typeList=obj.aaData;
	}
	function saveProductOrder(){
		var type_ids="";
		var product_ids="";
		var product_brands="";
		var product_names="";
		var product_models="";
		var product_standards="";
		var units="";
		var use_positions="";
		var sale_prices="";
		var discounts="";
		var amounts="";
		var typeId="";
		var prices="";
		var sale_modes="";
		for(var i=0;i<typeList.length;i++){
			if(typeList[i].parent_type=="-1")continue;
			if(typeList[i].parent_type!='0'){
				if($("#product_"+typeList[i].type_id).val()!=""&&$("#product_"+typeList[i].type_id).val()!=null){
					typeId=typeList[i].type_id;
					var checkMsg = checkFormDoQuote(typeId);
					if ( checkMsg != '' ) {
						top.showInfoWinWarn(checkMsg);
						return ;
					}
					type_ids+=typeId+",";
					product_ids+=$("#type_"+typeId+"_product_id").val()+",";
					product_brands+=$("#tdtype_"+typeId+"_product_brand").html()+",";
					product_names+= $("#product_"+typeId).find("option:selected").text()+",";
					product_models+=$("#type_"+typeId+"_product_model").html()+",";
					product_standards+=$("#type_"+typeId+"_product_standard").html()+",";
					units+=$("#type_"+typeId+"_unit").val()+",";
					use_positions+=$("#type_"+typeId+"_use_position").val()+",";
					sale_prices+=$("#type_"+typeId+"_sale_price").html()+",";
					discounts+=$("#type_"+typeId+"_discount").html()+",";
					amounts+=$("#type_"+typeId+"_amount").val()+",";
					prices+=$("#type_"+typeId+"_price").html()+",";
					sale_modes+=$("#type_"+typeId+"_sale_mode").html()+",";
				}
			}
		}
		if(info_id==0){
			 top.showInfoWinWarn("请首先保存客户基本信息！");
			 return;
		}
				var aoData=[];
			    aoData.push( { "name": "quote_detail.order_id", "value":info_id } );
				aoData.push( { "name": "type_idStr", "value": type_ids} );
				aoData.push( { "name": "product_idStr", "value": product_ids} );
				aoData.push( { "name": "quote_detail.product_brand", "value":product_brands} );
				aoData.push( { "name": "quote_detail.product_name", "value": product_names} );
				aoData.push( { "name": "quote_detail.product_model", "value": product_models } );
				aoData.push( { "name": "quote_detail.product_standard", "value": product_standards} );
				aoData.push( { "name": "quote_detail.unit", "value":units } );
				aoData.push( { "name": "quote_detail.use_position", "value": use_positions} );
				aoData.push( { "name": "prices", "value": prices} );
				aoData.push( { "name": "quote_detail.sale_mode", "value": sale_modes} );
				aoData.push( { "name": "sale_priceStr", "value":sale_prices} );
				aoData.push( { "name": "discountStr", "value":discounts} );
				aoData.push( { "name": "amountStr", "value": amounts} );
				var xurl="/actions/ProductQuote.action?insertQuoteDetail";
				top.sendAjaxRequest(xurl,aoData,saveOrderDetailCallBack);
	}
	
	function getProductList(){
	   top.sendAjaxRequest("/actions/ProductInfo.action?getAllProductInfoList",null,initProductList); 
	}
	//查询产品列表结果
	function initProductList(obj){
	     productList=obj.body.productList;
		 initTypeSelect();
	}
	function getCertenProduct(sid){
		proId=($("#"+sid).val());
		var prePrice=0;
		var nowPrice=0;
		var preSum=0;
		var nowSum=0;
		curProductIndex=sid.split("_")[1];
		removeHt='<a href="javascript:void(0)" onclick="removeProduct(\''+curProductIndex+'\')">删除</a>';
		$("#span_type_"+curProductIndex+"_optType").html(removeHt);
		try{
			if($("#type_"+curProductIndex+"_discount").html()!=''&&$("#type_"+curProductIndex+"_discount").html()!=null){
				prePrice=parseFloat($("#type_"+curProductIndex+"_discount").html())*parseFloat($("#type_"+curProductIndex+"_sale_price").html());
				preSum=parseInt($("#type_"+curProductIndex+"_amount").val());
			}else{
				prePrice=0;
				preSum=0;
			}
		}catch(e){
			prePrice=0;
			preSum=0;
		}
		//当前选择为空
		if(proId==""||proId==null){
			$("#tdtype_"+curProductIndex+"_product_brand").html("");
			$("#type_"+curProductIndex+"_product_model").html("");
			$("#tdtype_"+curProductIndex+"_unit").html("");
			$("#type_"+curProductIndex+"_product_standard").html("");
			$("#type_"+curProductIndex+"_sale_price").html("");
			$("#type_"+curProductIndex+"_discount").html("");
			$("#type_"+curProductIndex+"_product_brand").val("");
			$("#type_"+curProductIndex+"_unit").val("");
			$("#type_"+curProductIndex+"_product_id").val("");
			$("#type_"+curProductIndex+"_amount").val("0");
			$("#type_"+curProductIndex+"_use_position").val("");
			$("#type_"+curProductIndex+"_price").html("");
			$("#type_"+curProductIndex+"_sale_mode").html("");
			
			$("#view_tdtype_"+curProductIndex+"_product_brand").html("");
			$("#view_type_"+curProductIndex+"_product_model").html("");
			$("#view_tdtype_"+curProductIndex+"_unit").html("");
			$("#view_type_"+curProductIndex+"_product_standard").html("");
			$("#view_type_"+curProductIndex+"_sale_price").html("");
			$("#view_type_"+curProductIndex+"_discount").html("");
			$("#view_type_"+curProductIndex+"_product_brand").html("");
			$("#view_type_"+curProductIndex+"_unit").html("");
			$("#view_type_"+curProductIndex+"_product_id").html("");
			$("#view_type_"+curProductIndex+"_amount").html("0");
			$("#view_type_"+curProductIndex+"_use_position").html("");
			var money=parseFloat(preSum*prePrice);
			var totalMoney=parseFloat($("#total_money").html());
			totalMoney-=parseFloat(money);
			$("#total_money").html(totalMoney);
		}else{
		//判断之前值是否为空
			for(var i=0;i<productList.length;i++){
				if(proId==productList[i].product_id){
					//typeId=productList[i].type_id;
					$("#tdtype_"+curProductIndex+"_product_brand").html(top.getSupplierNameById(productList[i].product_brand));
					$("#type_"+curProductIndex+"_product_model").html(productList[i].product_model);
					$("#tdtype_"+curProductIndex+"_unit").html(top.getCodeName("UNIT",productList[i].unit));
					$("#type_"+curProductIndex+"_product_standard").html(productList[i].product_standard);
					$("#type_"+curProductIndex+"_sale_price").html(productList[i].price);
					$("#type_"+curProductIndex+"_discount").html(productList[i].discount);
					$("#type_"+curProductIndex+"_product_brand").val(productList[i].product_brand);
					$("#type_"+curProductIndex+"_unit").val(productList[i].unit);
					$("#type_"+curProductIndex+"_product_id").val(productList[i].product_id);
					$("#type_"+curProductIndex+"_price").html(productList[i].raw_price);
			        $("#type_"+curProductIndex+"_sale_mode").html(productList[i].sale_mode);
					
					$("#view_tdtype_"+curProductIndex+"_product_brand").html(top.getSupplierNameById(productList[i].product_brand));
					$("#view_type_"+curProductIndex+"_product_model").html(productList[i].product_model);
					$("#view_tdtype_"+curProductIndex+"_unit").html(top.getCodeName("UNIT",productList[i].unit));
					$("#view_type_"+curProductIndex+"_product_standard").html(productList[i].product_standard);
					$("#view_type_"+curProductIndex+"_sale_price").html(productList[i].price);
					$("#view_type_"+curProductIndex+"_discount").html(productList[i].discount);
					$("#view_type_"+curProductIndex+"_product_brand").val(productList[i].product_brand);
					$("#view_type_"+curProductIndex+"_unit").val(productList[i].unit);
					$("#view_type_"+curProductIndex+"_product_id").val(productList[i].product_id);
					if($("#type_"+curProductIndex+"_amount").val()==""||$("#type_"+curProductIndex+"_amount").val()=="0")
					{
					 $("#type_"+curProductIndex+"_amount").val("1");
					 $("#view_type_"+curProductIndex+"_amount").html("1");
					}
					break;
				}
			}//当前选择不为空时操作
			nowPrice=parseFloat($("#type_"+curProductIndex+"_discount").html())*parseFloat($("#type_"+curProductIndex+"_sale_price").html());
			nowSum=parseInt($("#type_"+curProductIndex+"_amount").val());
			var money=parseFloat(nowPrice*nowSum)-parseFloat(preSum*prePrice);
			var totalMoney=parseFloat($("#total_money").html());
			totalMoney+=parseFloat(money);
			$("#total_money").html(totalMoney);
		}
	}
	function removeProduct(productRowIndex){
		var nowPrice=parseFloat($("#type_"+productRowIndex+"_discount").html())*parseFloat($("#type_"+productRowIndex+"_sale_price").html());
		var nowSum=parseInt($("#type_"+productRowIndex+"_amount").val());
		var money=parseFloat(nowPrice*nowSum);
		var total=$("#total_money").html()-money;
		$("#total_money").html(total);
		$("#span_type_"+productRowIndex+"_optType").parent().parent().remove();
		
	}
	function countTotal(typeId,prePrice,nowPrice,preSum,nowSum){
		var parentId="";
		var proSum=0;
		var totalSum=0;
		var money=0;
		var totalMoney=0;
		if(typeList){
			for(var i=0;i<typeList.length;i++){
				if(typeList[i].type_id==typeId){
				  parentId=typeList[i].parent_type;
				  break;
				}
			}
			money=parseFloat(nowPrice*nowSum)-parseFloat(preSum*prePrice);
			totalMoney=parseFloat($("#totalMoney").html());
			totalMoney+=money;
			money=parseFloat($("#parentType_proMoney_"+parentId).html())+money;
			if(money<0){
			money=0;
			}
			if(totalMoney<0){
			totalMoney=0;
			}
			$("#parentType_proMoney_"+parentId).html(money);
			$("#totalMoney").html(totalMoney);
		}
	}
	
	function focuseAmount(value){
		tempAmout=value;
	}
	function changeAmount(typeId){
	
	   var price=parseFloat($("#type_"+typeId+"_discount").html())*parseFloat($("#type_"+typeId+"_sale_price").html());
	   var nowSum=parseInt($("#type_"+typeId+"_amount").val());
	   var money=parseFloat(price*nowSum)-parseFloat(tempAmout*price);
	   var totalMoney=parseFloat($("#total_money").html());
	   totalMoney+=money;
	   $("#total_money").html(totalMoney);
	}
//----------------version 2------------------------
	//增加行
	function addProdcuctRow(){
		productIndex++;
		var ht="";
		ht+="<tr class='tr_data'><td align='left'><select onclick='showDiv("+productIndex+")' id='type_"+productIndex+"'></select></td><td><select width='80px' id='type_"+productIndex+"_product_name' onchange='getCertenProduct(this.id)'></select></td>";
		ht+='<td  width="80px" id="tdtype_'+productIndex+'_product_brand">&nbsp;</td>';
		ht+='<td  width="80px" id="type_'+productIndex+'_product_model">&nbsp;</td>';
		ht+='<td  width="80px" id="type_'+productIndex+'_product_standard">&nbsp;</td>';
		ht+='<td  width="80px" id="tdtype_'+productIndex+'_unit">&nbsp;</td>';
		ht+='<td  width="80px" id="type_'+productIndex+'_sale_price" align="right">&nbsp;</td>';
		ht+='<td  width="80px" id="type_'+productIndex+'_discount"></td>';
		ht+='<td  width="80px"><input type="text" size="8" padding="0" id="type_'+productIndex+'_use_position"/></td>';
		ht+='<td  width="80px"><input onFocus="focuseAmount(this.value)" onChange="changeAmount('+productIndex+')"  type="text" size="4" padding="0" id="type_'+productIndex+'_amount"/></td>';
		ht+='<td >';
		ht+='<input type="hidden" id="type_'+productIndex+'_product_id">';
		ht+='<input type="hidden" id="type_'+productIndex+'_product_brand">';
		ht+='<input type="hidden" id="type_'+productIndex+'_unit">';
		
		ht+='<span id="span_type_'+productIndex+'_optType">';
		ht+='</span>';
		ht+='</td>';
		ht+='<td  style="display:none" id="type_'+productIndex+'_price"></td>';
		ht+='<td  style="display:none" id="type_'+productIndex+'_sale_mode"></td>';
		ht+='</tr>';
		$("#productDetailList").append(ht);
		var view_ht="";
		    view_ht+="<tr class='tr_data'><td id='view_type_"+productIndex+"'></td><td align='left' id='view_type_"+productIndex+"_product_name'></td>";
			view_ht+='<td  width="80px" id="view_tdtype_'+productIndex+'_product_brand">&nbsp;</td>';
			view_ht+='<td  width="80px" id="view_type_'+productIndex+'_product_model">&nbsp;</td>';
			view_ht+='<td  width="80px" id="view_type_'+productIndex+'_product_standard">&nbsp;</td>';
			view_ht+='<td  width="70px" id="view_tdtype_'+productIndex+'_unit">&nbsp;</td>';
			view_ht+='<td  width="70px" id="view_type_'+productIndex+'_sale_price" align="right">&nbsp;</td>';
			view_ht+='<td  width="80px" id="view_type_'+productIndex+'_discount"></td>';
			view_ht+='<td  width="80px" id="view_type_'+productIndex+'_use_position"></td>';
			view_ht+='<td  width="80px" id="view_type_'+productIndex+'_amount"></td>';
			view_ht+='</tr>';
			$("#view_productDetailList").append(view_ht);
		
	}
	//保存报价
	function saveOrderDetail(){
		var type_ids="";
		var product_ids="";
		var product_brands="";
		var product_names="";
		var product_models="";
		var product_standards="";
		var units="";
		var use_positions="";
		var sale_prices="";
		var discounts="";
		var amounts="";
		var typeId="";
		var prices="";
		var sale_modes="";
		if(productIndex!=0){
			for(var i=0;i<productIndex+1;i++){
					if($("#type_"+i).val()!=null&&$("#type_"+i+"_product_name").val()!=null&&$("#type_"+i+"_product_name").val()!=''){
						var checkMsg = checkFormDoQuote(i);
						if ( checkMsg != '' ) {
							top.showInfoWinWarn(checkMsg);
							return ;
						}
						type_ids+=$("#type_"+i).val()+",";
						product_ids+=$("#type_"+i+"_product_id").val()+",";
						product_brands+=$("#type_"+i+"_product_brand").val()+",";
						product_names+= $("#type_"+i+"_product_name").find("option:selected").text()+",";
						product_models+=$("#type_"+i+"_product_model").html()+",";
						product_standards+=$("#type_"+i+"_product_standard").html()+",";
						units+=$("#type_"+i+"_unit").val()+",";
						sale_prices+=$("#type_"+i+"_sale_price").html()+",";
						discounts+=$("#type_"+i+"_discount").html()+",";
						amounts+=$("#type_"+i+"_amount").val()+",";
						prices+=$("#type_"+i+"_price").html()+",";
						sale_modes+= $("#type_"+i+"_sale_mode").html()+",";
						if($("#type_"+i+"_use_position").val()!=''){
							use_positions+=$("#type_"+i+"_use_position").val()+",";
						}else{
							use_positions+="无,";
						}
					}
				}
				if(info_id==0){
					 top.showInfoWinWarn("请首先保存客户基本信息！");
					 return;
				}
				if(type_ids!=''){
					var aoData=[];
					aoData.push( { "name": "orderdetail.order_id", "value":info_id } );
					aoData.push( { "name": "type_idStr", "value": type_ids} );
					aoData.push( { "name": "product_idStr", "value": product_ids} );
					aoData.push( { "name": "orderdetail.product_brand", "value":product_brands} );
					aoData.push( { "name": "orderdetail.product_name", "value": product_names} );
					aoData.push( { "name": "orderdetail.product_model", "value": product_models } );
					aoData.push( { "name": "orderdetail.product_standard", "value": product_standards} );
					aoData.push( { "name": "orderdetail.unit", "value":units } );
					aoData.push( { "name": "orderdetail.use_position", "value": use_positions} );
					aoData.push( { "name": "orderdetail.sale_mode", "value": sale_modes} );
					aoData.push( { "name": "sale_priceStr", "value":sale_prices} );
					aoData.push( { "name": "discountStr", "value":discounts} );
					aoData.push( { "name": "amountStr", "value": amounts} );
					aoData.push( { "name": "prices", "value": prices} );
					var xurl="/actions/ProductQuote.action?insertOrderDetail";
					top.sendAjaxRequest(xurl,aoData,saveOrderDetailCallBack);
				}
		}
		$("#productDetailList").show();
	    //$("#view_productDetailList").hide();
	    //$("#saveProBtn").html('保存');
	    //$("#cancleProBtn").show();
	}
	
	//初始化报价表格
	function initTypeSelect(){
		 //var view_ht = '<tr align="center"><td width="180px">产品类别</td><td width="80px">名称</td><td width="80px">品牌</td><td width="80px">型号</td><td width="80px">规格</td><td width="70px">单位</td><td width="70px">单价</td><td width="80px">折扣</td><td width="100px">使用位置</td><td width="80px">数量</td></tr>';
		var ht='<tr align="center"><td width="180px">产品类别</td><td width="80px">名称</td><td width="80px">品牌</td><td width="80px">型号</td><td width="80px">规格</td><td width="70px">单位</td><td width="70px">单价</td><td width="80px">折扣</td><td width="100px">使用位置</td><td width="80px">数量</td><td >操作</td></tr>';
		for(;productIndex<10;productIndex++){
			ht+="<tr class='tr_data'><td align='left'><select onclick='showDiv("+productIndex+")' id='type_"+productIndex+"'><option value=''></option></select></td><td><select width='80px' id='type_"+productIndex+"_product_name' onchange='getCertenProduct(this.id)'></select></td>";
			ht+='<td  width="80px" id="tdtype_'+productIndex+'_product_brand">&nbsp;</td>';
			ht+='<td  width="80px" id="type_'+productIndex+'_product_model">&nbsp;</td>';
			ht+='<td  width="80px" id="type_'+productIndex+'_product_standard">&nbsp;</td>';
			ht+='<td  width="70px" id="tdtype_'+productIndex+'_unit">&nbsp;</td>';
			ht+='<td  width="70px" id="type_'+productIndex+'_sale_price" align="center">&nbsp;</td>';
			ht+='<td  width="80px" id="type_'+productIndex+'_discount"></td>';
			ht+='<td  width="80px"><input type="text" size="8" padding="0" id="type_'+productIndex+'_use_position"/></td>';
			ht+='<td  width="80px"><input onFocus="focuseAmount(this.value)" onChange="changeAmount('+productIndex+')"  type="text" size="4" padding="0" id="type_'+productIndex+'_amount"/></td>';
			ht+='<td >';
			ht+='<input type="hidden" id="type_'+productIndex+'_product_id">';
			ht+='<input type="hidden" id="type_'+productIndex+'_product_brand">';
			ht+='<input type="hidden" id="type_'+productIndex+'_unit">';
			ht+='<input type="hidden" id="type_'+productIndex+'_detail_id">'
			ht+='<span id="span_type_'+productIndex+'_optType">';
			ht+='</span>';
			ht+='</td>';
		   ht+='<td  style="display:none" id="type_'+productIndex+'_price"></td>';
		   ht+='<td  style="display:none" id="type_'+productIndex+'_sale_mode"></td>';
			ht+='</tr>';
			
			/*view_ht+="<tr class='tr_data' height='27px'><td id='view_type_"+productIndex+"'></td><td align='left' id='view_type_"+productIndex+"_product_name'></td>";
			view_ht+='<td  width="80px" id="view_tdtype_'+productIndex+'_product_brand">&nbsp;</td>';
			view_ht+='<td  width="80px" id="view_type_'+productIndex+'_product_model">&nbsp;</td>';
			view_ht+='<td  width="80px" id="view_type_'+productIndex+'_product_standard">&nbsp;</td>';
			view_ht+='<td  width="70px" id="view_tdtype_'+productIndex+'_unit">&nbsp;</td>';
			view_ht+='<td  width="70px" id="view_type_'+productIndex+'_sale_price" align="center">&nbsp;</td>';
			view_ht+='<td  width="80px" id="view_type_'+productIndex+'_discount"></td>';
			view_ht+='<td  width="80px" id="view_type_'+productIndex+'_use_position"></td>';
			view_ht+='<td  width="80px" id="view_type_'+productIndex+'_amount"></td>';
			view_ht+='</tr>';*/
		}
		$("#productDetailList").html(ht);
		//$("#view_productDetailList").html(view_ht);
		productIndex--;
		//queryAllOrderDetail();
	}
	
	//某类别下产品名称下拉列表
	function getProductSelectHtml(typeId,indexId){
		var pro_name=[];
		if(productList){
			for(var i=0;i<productList.length;i++){
				if(productList[i].type_id==typeId){
					pro_name.push(productList[i]);
				}else{
				}
			}
			$("#type_"+indexId+"_product_name").html(getProductNameSelectHtml(pro_name,""));
			
		}
	}
	//产品名称下拉列表
	function getProductNameSelectHtml(objArry,initUserCode){
		if ( !initUserCode ) initUserCode="";
		var ht="";
		if(objArry){
			ht+="<option value=''></option>";
			for(var i=0;i<objArry.length;i++){
			  ht+="<option value='"+objArry[i].product_id+"'";
			  if ( objArry[i].userCode == initUserCode ) {
			  ht+="selected ";
			//  $("#view_type_"+indexId+"_product_name").html(objArry[i].product_name);
			  }
			  ht+=">"+objArry[i].product_name+"</option>";
			}
		}
		return ht;
	}
	
//---------------------------产品类型树生成-----------------------
    // 加载产品类型数据
    function loadProTree(){
    	 top.sendAjaxRequest("/actions/ProductInfo.action?getProductTypeList",[],initProductTypeTree);
    }
    // 初始化产品类型树
    function initProductTypeTree(obj){
		   var ht="<div width='150px' style='float:right;margin-right:2px;cursor:pointer' onclick='hideDiv()'><img src='../../img/tab_iconrig3.png'/></div>";
    	   d=new dTree('d');
           d.config.useSelection = true;
           d.config.folderLinks = true;
           d.config.useStatusText = false;
           d.config.useLines = false;
           currentProId=0;

           if( obj.aaData ){
        	   for(var i=0;i<obj.aaData.length;i++){
        		   d.add( obj.aaData[i].type_id,obj.aaData[i].parent_type,obj.aaData[i].type_name );
        	   }
           }
		   
		   top.setProductTypeTree( d );

           $("#ProTypeTree").html( ht+d.toString() );
           treeObj = new JSDragDropTree();
           treeObj.setTreeId('dhtmlgoodies_tree2');
           treeObj.setMaximumDepth(20);
           treeObj.setMessageMaximumDepthReached('已到达最大的层次'); 
           treeObj.setRenameAllowed(true);
           treeObj.setDeleteAllowed(true);
           treeObj.initTree();
		   treeObj.collapseAll();
		   treeObj.showHideNode(false,'0');
          // treeObj.expandAll();
       }
    // 选中产品了类型节点后触发函数
    function onSelectedNode(nid){
    	   var name="";
    	   if ( nid == 0 ) {
    		   nid="";
    		   name="";
    	   }else name=d.getNodePath(nid);
				$("#type_"+curProductIndex).html("<option value='"+nid+"' selected>"+name+"</option>");
				$("#view_type_"+curProductIndex).html(name);
				getProductSelectHtml(nid,curProductIndex);
				getCertenProduct("type_"+curProductIndex+"_product_name");
				hideDiv();
       }
	   
	//控制产品类别选择菜单显示
	function showDiv(typeIndex){
		curProductIndex=typeIndex;
	    var y = $("#type_"+typeIndex).offset().top+30;
		var x = $("#type_"+typeIndex).offset().left+10; 
		
		$("#ProTypeTree").css("position", "absolute"); 
		$("#ProTypeTree").css("left",x); 
		$("#ProTypeTree").css("top", y);
		$("#ProTypeTree").css("display", "block");  	
		$("#ProTypeTree").show();
	}
	function hideDiv(){
		$("#ProTypeTree").hide();
	}
	
   //生成产品订单
   function generateOrder(){
		var aoData=[];
		var xurl="/actions/ProductQuote.action?createProductOrder";
		aoData.push( { "name": "quote_detail.order_id", "value":info_id} );
		//生成产品订单
		aoData.push( { "name": "product_order.require_id", "value":require_id} );
		aoData.push( { "name": "product_order.designerCode", "value":designerCode} );
		aoData.push( { "name": "product_order.pro_add", "value":$("#pro_add").html()} );
		aoData.push( { "name": "product_order.cust_code", "value":cust_code} );
		aoData.push( { "name": "product_order.cust_name", "value":$("#cust_name").html()} );
		aoData.push( { "name": "product_order.pro_designer", "value":pro_designer} );
		aoData.push( { "name": "product_order.project_order_id", "value":$("#project_order_id").html()} );
		aoData.push( { "name": "product_order.box_designer", "value":$("#box_designer").val()} );
		aoData.push( { "name": "product_order.cust_tel", "value":$("#view_cust_tel").html()} );
		top.sendAjaxRequest(xurl,aoData,generateOrderCallBack);
	
   }
   
   //生成订单后回调函数
   function generateOrderCallBack(obj){
      if(obj.status==true){
	     top.showInfoWinOK("生成订单成功！");
		 $("#generateOrderBtn").hide();
	  }else{
	     top.showInfoWinError("生成订单失败！");
	  }
   }
   
	</script>
<style>
body{
margin:10px;
margin-left:20px;
margin-right:20px;
}
body,td {
	font-size: 13px;
}

.roomTd {
	border: 1px;
	border-style: dotted none none none;
	border-color: blue;
	color: #000000;
	padding-left: 5px;
}

#KinSlideshow {
	overflow: hidden;
	width: 500px;
	height: 450px;
}

.inputBottomLine {
	border-top: hide;
	border-left: hide;
	border-center: hide;
}
#hall_count,#room_count,#bath_count,#amount{
	width: 50px;
}
#product_brand,#product_model,#product_standard,#price,#unit{
	width: 80px;
}
#product_name
{
	width: 100px;
}
table.attention{
	border-collapse:collapse;
	}
	table.attention td{
	border:solid 1px black;
	}
	.W_btn_round, .W_btn_round_ico, .W_btn_round2 {
		display: inline-block;
		border-width: 1px;
		border-style: solid;
		overflow: hidden;
		vertical-align: middle;
		cursor: pointer;
		border-radius: 11px;
		border-color: #d9d9d9;
		background-color: #f2f2f2;
		padding:3px 4px 3px 4px;
		margin-bottom:2px;
	}
	a{text-decoration:none}
</style>
	</head>
	<body>	
		<div>
				客户基本信息
				<hr style="width:70%;display:inline-block">
						<a id="saveCustBtn" onclick="saveProOrderInfo()" class="W_btn_round" href="javascript:void(0)">保存</a>
				</hr>
				<br>
				<table id="edit_cust_info" border="1" cellpadding="3" cellspacing="1" width="100%" align="center" style="background-color: #b9d8f3;font-size:13px">
					<tr class="tr_data">
						<td  width="10%" height="32px">产品订单编号</td><td width="15%" align="left"><label id="id">系统自动生成</label></td>
						<td width="10%" align="center">操作日期</td><td width="17%" align="left" id="order_date"></td>
						<td width="10%" >工程订单编号</td>
						<td colspan="3">
							<table>
								<tr class="tr_data" height="25px">
									<td><label id="project_order_id" ></label></td>
									<td>
										<div id="chooseProject" style="display:none" class="buttonDivTwo" width="30px">
											<a href="javascript:void(0)" onclick="chooseProject()">选择</a>
										</div>
									</td>
								</tr>
							</table>
						</td>
					</tr>
					<tr class="tr_data">	
						<td height="32px">客户姓名</td>
						<td>
							<table>
								<tr class="tr_data" height="25px">
									<td><label id="cust_name" ></label></td>
									<td>
										<div id="chooseCust" style="display:none" class="buttonDivTwo" width="30px">
											<a href="javascript:void(0)" onclick="chooseCust()">选择</a>
										</div>
									</td>
								</tr>
							</table>
						</td>
						<td >设计师姓名</td><td align="left"><label id="designerCode"></label></td>
						<td>产品设计师</td><td width="15%" align="left" id="tdpro_designer"></td>
						<td>柜体设计师</td><td width="15%" align="left" id="tdbox_designer"></td>
					</tr>
					<tr class="tr_data">
						<td height="32px">联系方式</td><td align="left"><label id="cust_tel"></label></td>
						<td height="32px">工程地址</td>
						<td colspan="5" align="left">
						 <label id="pro_add" type="text" size="50"></label>
						</td>
					</tr>
				</table>
			
				<br><br>
					订单信息
						<br>
				<table border="1" cellpadding="3" cellspacing="1" width="100%" align="center" style="background-color: #b9d8f3;" id="productDetailList">
				</table>
				<!--<table border="1" cellpadding="3" cellspacing="1" width="100%" align="center" style="display:none;background-color: #b9d8f3;" id="view_productDetailList">
				</table>!-->
				<div id="addProductRow"><a href="javascript:addProdcuctRow()">+</a></div>
				<div><span style="color:red">总计：<span id="total_money">0</span>元</span></div>
		<div id="dialog" title="" style="display: none; padding: 0 0 0 0; margin: 0 0 0 0; z-index: 10000">
			<iframe id="self_iframe" src="about:blank" width="100%" height="96%" frameborder="0"></iframe>
		</div>
	</div>
	<div class="dtree" id="ProTypeTree" style="margin:10px;padding:5px;border-width:2px;border-style:solid; border-color:#b9d8f3;background-color:white;display:none">
		</div>
		<br>
	</body>
	</html>